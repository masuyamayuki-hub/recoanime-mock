<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ãƒªã‚³ã‚¢ãƒ‹ãƒ¡ï¼šãƒ¢ãƒƒã‚¯ï¼ˆCSV + AIã‚³ãƒ¡ãƒ³ãƒˆ + å‹•ç”»ç”Ÿæˆï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f7fb;--card:#fff;--line:#e6e6ef;--text:#111;--muted:#6b7280;
    --brand:#2563eb;--ok:#16a34a;--warn:#ca8a04;--shadow:0 8px 20px rgba(0,0,0,.05);
  }
  body{margin:0;padding:24px;background:var(--bg);font-family:'Noto Sans JP',sans-serif;color:var(--text);}
  .wrap{max-width:1200px;margin:auto;display:grid;gap:20px;}
  @media(min-width:980px){.wrap{grid-template-columns:1.1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px;}
  h1{font-size:22px;margin:0 0 6px}
  .sub{font-size:13px;color:var(--muted);margin-bottom:16px}
  table{width:100%;border-collapse:collapse;border:1px solid var(--line);}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:13px;}
  th{background:#f9fafc;text-align:left}
  tr:hover td{background:#f2f6ff}
  .btn{padding:8px 14px;border-radius:999px;font-weight:600;border:1px solid var(--line);cursor:pointer;margin:3px;}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand);}
  .btn.success{background:var(--ok);color:#fff;border-color:var(--ok);}
  .btn.warn{background:var(--warn);color:#fff;border-color:var(--warn);}
  textarea,input,select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;font-size:14px;}
  textarea{min-height:120px;resize:vertical;}
  .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;}
  .progress>div{height:100%;width:0;background:var(--brand);transition:width .3s;}
  .small{font-size:12px;color:var(--muted)}
  .selected{outline:2px solid var(--brand)}
</style>
</head>
<body>
<header class="wrap">
  <div>
    <h1>ãƒªã‚³ã‚¢ãƒ‹ãƒ¡ï¼šæ–°ãƒ¢ãƒƒã‚¯</h1>
    <div class="sub">CSV â†’ Gemini AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ â†’ ã”å®¶æ—å‘ã‘ã‚¢ãƒ‹ãƒ¡ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰</div>
  </div>
</header>

<main class="wrap">
  <!-- CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
  <section class="card">
    <h2>â‘  CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <input type="file" id="csvFile" accept=".csv">
    <button class="btn" id="loadSample">ã‚µãƒ³ãƒ—ãƒ«CSVã‚’èª­ã¿è¾¼ã‚€</button>
    <div style="max-height:300px;overflow:auto;margin-top:8px;">
      <table id="csvTable" style="display:none"></table>
    </div>
  </section>

  <!-- AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ -->
  <section class="card">
    <h2>â‘¡ AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼ˆGeminiï¼‰</h2>
    <div class="small">Gemini APIï¼ˆCloudflare Worker çµŒç”±ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚</div>
    <div style="display:grid;gap:10px;margin-top:10px">
      <input id="name" placeholder="æ°åï¼ˆä¾‹ï¼šå±±ç”° å¤ªéƒï¼‰">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <input id="prev" placeholder="æ¯”è¼ƒå¯¾è±¡å€¤ï¼ˆä¾‹ï¼š65ï¼‰">
        <input id="curr" placeholder="ä»Šå›å€¤ï¼ˆä¾‹ï¼š70ï¼‰">
      </div>
      <textarea id="noticeText" placeholder="æ–½è¨­ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ï¼ˆä»»æ„ï¼‰"></textarea>
      <textarea id="personalNote" placeholder="ã”æ§˜å­ï¼ˆä»»æ„ï¼‰"></textarea>
      <textarea id="resultText" placeholder="ç”ŸæˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
      <div>
        <button class="btn primary" id="genGemini">ğŸŒ Geminiã§ç”Ÿæˆ</button>
      </div>
    </div>
  </section>

  <!-- ã‚¢ãƒ‹ãƒ¡ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ -->
  <section class="card">
    <h2>â‘¢ ã”å®¶æ—å‘ã‘ã‚¢ãƒ‹ãƒ¡ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰</h2>
    <div style="display:grid;gap:10px">
      <input id="videoName" placeholder="å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä»»æ„ï¼‰">
      <select id="theme">
        <option value="classic">ã‚¯ãƒ©ã‚·ãƒƒã‚¯ï¼ˆé’ç³»ï¼‰</option>
        <option value="warm">ã‚ãŸãŸã‹ã¿ï¼ˆæ©™ç³»ï¼‰</option>
        <option value="mono">ãƒ¢ãƒãƒˆãƒ¼ãƒ³ï¼ˆåŒ»ç™‚ç³»ï¼‰</option>
      </select>
      <button class="btn success" id="startJob">ã‚¢ãƒ‹ãƒ¡ç”Ÿæˆã‚’ä¾é ¼ã™ã‚‹</button>
      <button class="btn warn" id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div id="jobArea" style="margin-top:12px;display:none">
      <div class="progress"><div id="bar"></div></div>
      <pre id="jobLog" class="small" style="white-space:pre-wrap"></pre>
      <div id="videoLink"></div>
    </div>
  </section>
</main>

<script>
// ===== CSVèª­ã¿è¾¼ã¿ =====
const $ = s => document.querySelector(s);
function parseCSV(text){return text.trim().split(/\r?\n/).map(r=>r.split(','));}
$("#csvFile").addEventListener("change", async e=>{
  const file=e.target.files?.[0]; if(!file)return;
  const text=await file.text();
  buildTable(parseCSV(text));
});
$("#loadSample").addEventListener("click",()=>{
  const sample="æ°å,æ¯”è¼ƒå¯¾è±¡å€¤,ä»Šå›å€¤\nå±±ç”° å¤ªéƒ,65,72\nä½è—¤ èŠ±å­,50,48";
  buildTable(parseCSV(sample));
});
function buildTable(rows){
  const table=$("#csvTable"); table.innerHTML=''; table.style.display='table';
  const header=rows.shift();
  const thead=document.createElement("thead"); const trh=document.createElement("tr");
  header.forEach(h=>{const th=document.createElement("th"); th.textContent=h; trh.appendChild(th)});
  thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    r.forEach(c=>{const td=document.createElement("td"); td.textContent=c; tr.appendChild(td)});
    tr.addEventListener("click",()=>{setInputs(header,r,tr)});
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}
function setInputs(header,row,tr){
  document.querySelectorAll(".selected").forEach(e=>e.classList.remove("selected"));
  tr.classList.add("selected");
  const map={}; header.forEach((h,i)=>map[h]=row[i]);
  $("#name").value=map["æ°å"]||row[0]||"";
  $("#prev").value=map["æ¯”è¼ƒå¯¾è±¡å€¤"]||row[1]||"";
  $("#curr").value=map["ä»Šå›å€¤"]||row[2]||"";
}

// ===== Geminiå‘¼ã³å‡ºã— =====
const WORKER_URL="https://wispy-paper-5feb.masuyama-yuki.workers.dev";
$("#genGemini").addEventListener("click",async()=>{
  const name=$("#name").value.trim(),prev=$("#prev").value.trim(),curr=$("#curr").value.trim();
  const noticeText=$("#noticeText").value.trim(),personalNote=$("#personalNote").value.trim();
  if(!name||!prev||!curr){alert("æ°åãƒ»æ¯”è¼ƒå¯¾è±¡å€¤ãƒ»ä»Šå›å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");return;}
  const out=$("#resultText"); out.value="â³ Geminiã«å•ã„åˆã‚ã›ä¸­â€¦";
  try{
    const res=await fetch(WORKER_URL,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,prev,curr,noticeText,personalNote})
    });
    const txt=await res.text(); console.log("Worker response:",txt);
    let data; try{data=JSON.parse(txt);}catch{throw new Error("JSON parse error: "+txt);}
    if(res.ok && data.text){out.value=data.text.trim();}
    else throw new Error(data.error||"ç”Ÿæˆå¤±æ•—");
  }catch(e){console.error(e); out.value="âŒ ã‚¨ãƒ©ãƒ¼: "+e.message;}
});

// ===== ãƒ€ãƒŸãƒ¼å‹•ç”»ç”Ÿæˆ =====
$("#startJob").addEventListener("click",async()=>{
  const name=$("#name").value.trim(); if(!name){alert("æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  $("#jobArea").style.display="block";
  const bar=$("#bar"),log=$("#jobLog"); bar.style.width="0%"; log.textContent="";
  const steps=["æº–å‚™ä¸­...","ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ...","ã‚·ãƒ¼ãƒ³ç”Ÿæˆ...","ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...","ä¿å­˜å®Œäº†"];
  for(let i=0;i<steps.length;i++){
    log.textContent+=steps[i]+"\n"; bar.style.width=((i+1)/steps.length*100)+"%";
    await new Promise(r=>setTimeout(r,600));
  }
  const fname=$("#videoName").value||("recoanime_"+name+".mp4");
  $("#videoLink").innerHTML=`<span>å‡ºåŠ›URL:</span> <a href="/videos/${fname}" target="_blank">${fname}</a>`;
});
$("#reset").addEventListener("click",()=>{
  ["name","prev","curr","noticeText","personalNote","resultText","videoName"].forEach(id=>$("#"+id).value="");
  $("#bar").style.width="0%"; $("#jobLog").textContent=""; $("#videoLink").innerHTML=""; $("#jobArea").style.display="none";
});
</script>
</body>
</html>
