<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ご家族さま向けお知らせ・生成モック（AI Studio無料枠 / 自動モデル検出）</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--line:#e5e7eb;--muted:#6b7280;--primary:#1e88e5;--mail:#00b894;--radius:14px}
  *{box-sizing:border-box}
  body{margin:0;padding:24px;font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#111827;line-height:1.6}
  h1{margin:0 0 8px;font-size:22px;font-weight:700}
  .sub{color:var(--muted);margin:0 0 16px;font-size:12px}
  .grid{display:grid;gap:18px;max-width:1080px;margin:0 auto}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius)}
  .inner{padding:16px}
  .hd{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:700}
  textarea{width:100%;min-height:160px;border:1px solid var(--line);border-radius:12px;padding:12px;font-size:15px;resize:vertical}
  .row{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
  select,button{font-size:14px}
  button{appearance:none;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:8px;padding:8px 10px;margin-top:10px;display:none;font-size:12px;white-space:pre-wrap}
  .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;border-radius:8px;padding:8px 10px;margin-top:10px;display:none;font-size:12px}
  .loader{display:inline-flex;align-items:center;gap:6px}
  .dot{width:6px;height:6px;border-radius:50%;background:#111;opacity:.6;animation:b 1s infinite alternate}
  .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
  @keyframes b{from{transform:translateY(0)}to{transform:translateY(-3px)}}
  .mail{border:1px solid var(--line)}
  .mail-top{background:var(--mail);color:#fff;padding:10px 14px;font-weight:700;font-size:18px;display:flex;justify-content:space-between;align-items:center}
  .mail-body{padding:16px 18px}
  .small{font-size:12px;color:#374151}
  .genbox{border:2px solid #ef4444;border-radius:10px;padding:12px;min-height:110px;white-space:pre-wrap;background:#fff}
  .hr{border:none;border-top:1px dashed #9ca3af;margin:14px 0}
  .pill{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;font-size:11px;color:#3730a3}
  details{margin-top:8px}
  summary{cursor:pointer;font-size:12px;color:#4b5563}
  pre{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px;overflow:auto;font-size:12px}
</style>
</head>
<body>
  <h1>ご家族さま向けお知らせ・生成モック（AI Studio無料枠 / 自動モデル検出）</h1>
  <p class="sub"><span class="pill" id="engineState">Engine: 検出中…</span></p>

  <div class="grid">
    <!-- 左：入力 -->
    <section class="card">
      <div class="hd">入力（箇条書き）</div>
      <div class="inner">
        <label for="bullets" style="font-weight:700">1行=1項目（例：日付＋内容 / 季節の一言 / 注意事項）</label>
        <textarea id="bullets" placeholder="10/12　お買い物イベント（しまむら）&#10;10/20　施設創立30周年&#10;朝晩冷え込み"></textarea>

        <div class="row">
          <label for="tone" style="font-weight:700">文体</label>
          <select id="tone">
            <option value="polite" selected>丁寧（です・ます）</option>
            <option value="casual">カジュアル</option>
          </select>
          <button id="sample">サンプル</button>
        </div>

        <div class="row">
          <button id="generate" class="btn-primary">生成AIでつくる</button>
        </div>

        <div id="ok" class="ok"></div>
        <div id="err" class="error"></div>
        <p class="hint">ドメイン制限を使う場合は <code id="originBox"></code> を AI Studio の Allowed domains / HTTPリファラー制限に登録してください。</p>
        <details id="debugBox" style="display:none"><summary>デバッグ（API生レスポンス）</summary><pre id="debugPre"></pre></details>
      </div>
    </section>

    <!-- 右：生成結果 -->
    <section class="mail" aria-live="polite">
      <div class="mail-top"><span>生成結果（送信メール内容へ反映）</span></div>
      <div class="mail-body">
        <div class="small">利用者ご家族様</div>
        <div class="small">こんにちは。<br>●●事業所の●●です。</div>
        <div class="genbox" id="out">（左の赤枠に箇条書きを入力し、「生成AIでつくる」を押すとここに文章が入ります）</div>
        <p class="small" style="margin-top:10px">利用者様のバーセルインデックス（日常生活活動）の結果をアニメーション形式でお送りいたします。</p>
        <hr class="hr">
        <div class="small">
          お問い合わせ先<br>テスト事業所<br>東京都テスト市 123-1 建物名<br>TEL:1234567890<br>MAIL:●●@njc.co.jp
        </div>
      </div>
    </section>
  </div>

<script>
  // ====== AI Studio APIキー（ご指定の値） ======
  const RAW_KEY = "AIzaSyAmLXF9IQDUYo7fef33wNp_69yuncyMLUY";
  const API_KEY = RAW_KEY.trim();

  // ====== DOM ======
  const $ = s => document.querySelector(s);
  const bullets = $('#bullets'), toneSel = $('#tone'), out = $('#out');
  const ok = $('#ok'), err = $('#err'), engineState = $('#engineState');
  const debugBox = $('#debugBox'), debugPre = $('#debugPre');
  const originBox = $('#originBox');
  if (originBox) originBox.textContent = location.origin || "(file:// は不可。httpサーバで開いてください)";

  // ====== 永続化 & サンプル ======
  bullets.value = localStorage.getItem('mock.bullets') || '';
  toneSel.value = localStorage.getItem('mock.tone') || 'polite';
  function persist(){ localStorage.setItem('mock.bullets', bullets.value); localStorage.setItem('mock.tone', toneSel.value); }
  bullets.addEventListener('input', persist);
  toneSel.addEventListener('change', persist);
  $('#sample').addEventListener('click', ()=>{ bullets.value = ['10/12　お買い物イベント（しまむら）','10/20　施設創立30周年','朝晩冷え込み'].join('\n'); persist(); });

  // ========= モデル自動検出 =========
  const PreferredOrder = ['gemini-2.5-flash','gemini-2.5-flash-lite','gemini-2.0-flash','gemini-2.0-flash-lite','gemini-1.5-flash'];
  let BASE = null, MODEL = null, ALL_MODELS = [];

  async function listModels(base){
    const res = await fetch(`${base}/models?key=${encodeURIComponent(API_KEY)}`);
    if (!res.ok) throw new Error(`${base} ListModels failed: ${res.status}\n${await res.text()}`);
    const j = await res.json();
    return (j.models || []).filter(m => (m.supportedGenerationMethods||[]).includes('generateContent')).map(m => m.name.split('/').pop());
  }
  function pickPreferred(names){
    for (const want of PreferredOrder){ if (names.includes(want)) return want; }
    return names[0] || null;
  }
  async function initModel(){
    try{
      const v1 = await listModels('https://generativelanguage.googleapis.com/v1');
      if (v1.length){ BASE='https://generativelanguage.googleapis.com/v1'; ALL_MODELS = v1; MODEL = pickPreferred(v1); engineState.textContent=`Engine: v1 / ${MODEL}`; return; }
    }catch(e){ console.warn('v1 list error', e); }
    const v1b = await listModels('https://generativelanguage.googleapis.com/v1beta');
    if (v1b.length){ BASE='https://generativelanguage.googleapis.com/v1beta'; ALL_MODELS = v1b; MODEL = pickPreferred(v1b); engineState.textContent=`Engine: v1beta / ${MODEL}`; return; }
    throw new Error('利用可能なモデルが見つかりませんでした（APIキー/ドメイン制限をご確認ください）');
  }

  // ========= プロンプト =========
  function buildPrompt(lines, tone){
    const style = (tone === 'polite') ? '丁寧な敬体（です・ます）' : 'やわらかいカジュアル体';
    return [
      "あなたは介護事業所の職員として、ご家族向けのお知らせ文を作成します。",
      "与えられた箇条書きの事実をもとに、200文字前後で日本語の短い段落を1つ作ってください。",
      "文体:", style + "。",
      "条件: 1) 誇張しない 2) 日付は「○日に〜を予定しています」と自然に言い換える 3) 季節の一言があれば冒頭に 4) 結びは簡潔に。",
      "箇条書き:",
      lines.map(l => "- " + l).join("\\n"),
      "出力は本文のみ。"
    ].join("\\n");
  }

  // ========= 共通: テキスト抽出 =========
  function extractText(data){
    const cands = Array.isArray(data?.candidates) ? data.candidates : [];
    for (const c of cands){
      if (Array.isArray(c?.content?.parts)){
        const t = c.content.parts.map(p => p?.text || "").join("");
        if (t) return t.trim();
      }
    }
    for (const c of cands){
      const t = c?.content?.[0]?.text || c?.text || c?.output;
      if (t) return String(t).trim();
    }
    const t3 = data?.output_text || data?.generated_text || data?.text;
    if (t3) return String(t3).trim();
    return "";
  }

  // ========= 呼び出し（フォールバック付き） =========
  async function callOnce(base, model, prompt){
    const url = `${base}/models/${model}:generateContent?key=${encodeURIComponent(API_KEY)}`;
    const payload = {
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: { maxOutputTokens: 256, temperature: 0.7 }
      // ※ responseMimeType は未対応環境があるため指定しない
      // ※ safetySettings も互換優先で外す
    };
    const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const raw = await res.text();
    let data = null; try{ data = JSON.parse(raw); }catch{}
    if (!res.ok) throw new Error(`Gemini API error: ${res.status}\n${raw}`);
    document.getElementById('debugBox').style.display = 'block';
    document.getElementById('debugPre').textContent = raw;
    return extractText(data);
  }

  async function callGemini(prompt){
    // 1) 現在のモデル
    let t = await callOnce(BASE, MODEL, prompt);
    if (t) return t;

    // 2) 同じBASEで他モデル
    for (const m of ALL_MODELS){
      if (m === MODEL) continue;
      try{
        t = await callOnce(BASE, m, prompt);
        if (t){ MODEL = m; engineState.textContent = `${BASE.endsWith('/v1') ? 'Engine: v1' : 'Engine: v1beta'} / ${MODEL} (switched)`; return t; }
      }catch(e){ console.warn('alt model fail', m, e); }
    }

    // 3) BASE切替
    const otherBase = BASE.endsWith('/v1') ? 'https://generativelanguage.googleapis.com/v1beta' : 'https://generativelanguage.googleapis.com/v1';
    try{
      const names = await listModels(otherBase);
      for (const m of names){
        try{
          t = await callOnce(otherBase, m, prompt);
          if (t){ BASE = otherBase; MODEL = m; engineState.textContent = `${BASE.endsWith('/v1') ? 'Engine: v1' : 'Engine: v1beta'} / ${MODEL} (fallback)`; return t; }
        }catch(e){ console.warn('base switch fail', otherBase, m, e); }
      }
    }catch(e){ console.warn('list other base fail', e); }

    throw new Error("応答は返りましたが本文を抽出できませんでした。数秒置いて再試行してください。");
  }

  // ========= 生成 =========
  async function generate(){
    err.style.display='none'; ok.style.display='none';
    const lines = (bullets.value||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!lines.length){ out.textContent = "（左の赤枠に箇条書きを入力してください）"; return; }

    out.innerHTML = '<span class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span> 生成中…';
    try{
      if (!BASE || !MODEL) await initModel();
      const prompt = buildPrompt(lines, toneSel.value);
      const text = await callGemini(prompt);
      
// 改行整形（「。」のあとに改行を追加）
const formatted = text
  .replace(/。(?=[^\n])/g, '。\n')     // 「。」のあとに改行
  .replace(/\n{2,}/g, '\n');          // 連続改行を1つに圧縮

out.textContent = formatted;
      ok.style.display='block'; ok.textContent = "生成に成功しました。";
    }catch(e){
      out.textContent = "（生成できませんでした）";
      err.style.display='block'; err.textContent = String(e?.message || e);
      console.error(e);
    }
  }

  // イベント
  document.getElementById('generate').addEventListener('click', generate);
  bullets.addEventListener('keydown', e => { if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); generate(); } });

  // 初期化
  if(!bullets.value) document.getElementById('sample').click();
  (async()=>{ try{ await initModel(); }catch(e){ console.warn('initModel warn:', e); }})();
</script>
</body>
</html>
