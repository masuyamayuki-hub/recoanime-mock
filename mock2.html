<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>リコアニメ：モック（CSV + AIコメント + 動画生成）</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f7fb;--card:#fff;--line:#e6e6ef;--text:#111;--muted:#6b7280;
    --brand:#2563eb;--ok:#16a34a;--warn:#ca8a04;--shadow:0 8px 20px rgba(0,0,0,.05);
  }
  body{margin:0;padding:24px;background:var(--bg);font-family:'Noto Sans JP',sans-serif;color:var(--text);}
  .wrap{max-width:1200px;margin:auto;display:grid;gap:20px;}
  @media(min-width:980px){.wrap{grid-template-columns:1.1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px;}
  h1{font-size:22px;margin:0 0 6px}
  .sub{font-size:13px;color:var(--muted);margin-bottom:16px}
  table{width:100%;border-collapse:collapse;border:1px solid var(--line);}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:13px;}
  th{background:#f9fafc;text-align:left}
  tr:hover td{background:#f2f6ff}
  .btn{padding:8px 14px;border-radius:999px;font-weight:600;border:1px solid var(--line);cursor:pointer;margin:3px;}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand);}
  .btn.success{background:var(--ok);color:#fff;border-color:var(--ok);}
  .btn.warn{background:var(--warn);color:#fff;border-color:var(--warn);}
  textarea,input,select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;font-size:14px;}
  textarea{min-height:120px;resize:vertical;}
  .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;}
  .progress>div{height:100%;width:0;background:var(--brand);transition:width .3s;}
  .small{font-size:12px;color:var(--muted)}
  .selected{outline:2px solid var(--brand)}
</style>
</head>
<body>
<header class="wrap">
  <div>
    <h1>リコアニメ：新モック</h1>
    <div class="sub">CSV → Gemini AIコメント生成 → ご家族向けアニメ生成（ダミー）</div>
  </div>
</header>

<main class="wrap">
  <!-- CSVアップロード -->
  <section class="card">
    <h2>① CSVアップロード</h2>
    <input type="file" id="csvFile" accept=".csv">
    <button class="btn" id="loadSample">サンプルCSVを読み込む</button>
    <div style="max-height:300px;overflow:auto;margin-top:8px;">
      <table id="csvTable" style="display:none"></table>
    </div>
  </section>

  <!-- AIコメント生成 -->
  <section class="card">
    <h2>② AIコメント生成（Gemini）</h2>
    <div class="small">Gemini API（Cloudflare Worker 経由）を使用してコメントを生成します。</div>
    <div style="display:grid;gap:10px;margin-top:10px">
      <input id="name" placeholder="氏名（例：山田 太郎）">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <input id="prev" placeholder="比較対象値（例：65）">
        <input id="curr" placeholder="今回値（例：70）">
      </div>
      <textarea id="noticeText" placeholder="施設からのお知らせ（任意）"></textarea>
      <textarea id="personalNote" placeholder="ご様子（任意）"></textarea>
      <textarea id="resultText" placeholder="生成結果がここに表示されます"></textarea>
      <div>
        <button class="btn primary" id="genGemini">🌐 Geminiで生成</button>
      </div>
    </div>
  </section>

  <!-- アニメ生成（ダミー） -->
  <section class="card">
    <h2>③ ご家族向けアニメ生成（ダミー）</h2>
    <div style="display:grid;gap:10px">
      <input id="videoName" placeholder="出力ファイル名（任意）">
      <select id="theme">
        <option value="classic">クラシック（青系）</option>
        <option value="warm">あたたかみ（橙系）</option>
        <option value="mono">モノトーン（医療系）</option>
      </select>
      <button class="btn success" id="startJob">アニメ生成を依頼する</button>
      <button class="btn warn" id="reset">リセット</button>
    </div>
    <div id="jobArea" style="margin-top:12px;display:none">
      <div class="progress"><div id="bar"></div></div>
      <pre id="jobLog" class="small" style="white-space:pre-wrap"></pre>
      <div id="videoLink"></div>
    </div>
  </section>
</main>

<script>
// ===== CSV読み込み =====
const $ = s => document.querySelector(s);
function parseCSV(text){return text.trim().split(/\r?\n/).map(r=>r.split(','));}
$("#csvFile").addEventListener("change", async e=>{
  const file=e.target.files?.[0]; if(!file)return;
  const text=await file.text();
  buildTable(parseCSV(text));
});
$("#loadSample").addEventListener("click",()=>{
  const sample="氏名,比較対象値,今回値\n山田 太郎,65,72\n佐藤 花子,50,48";
  buildTable(parseCSV(sample));
});
function buildTable(rows){
  const table=$("#csvTable"); table.innerHTML=''; table.style.display='table';
  const header=rows.shift();
  const thead=document.createElement("thead"); const trh=document.createElement("tr");
  header.forEach(h=>{const th=document.createElement("th"); th.textContent=h; trh.appendChild(th)});
  thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    r.forEach(c=>{const td=document.createElement("td"); td.textContent=c; tr.appendChild(td)});
    tr.addEventListener("click",()=>{setInputs(header,r,tr)});
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}
function setInputs(header,row,tr){
  document.querySelectorAll(".selected").forEach(e=>e.classList.remove("selected"));
  tr.classList.add("selected");
  const map={}; header.forEach((h,i)=>map[h]=row[i]);
  $("#name").value=map["氏名"]||row[0]||"";
  $("#prev").value=map["比較対象値"]||row[1]||"";
  $("#curr").value=map["今回値"]||row[2]||"";
}

// ===== Gemini呼び出し =====
const WORKER_URL="https://wispy-paper-5feb.masuyama-yuki.workers.dev";
$("#genGemini").addEventListener("click",async()=>{
  const name=$("#name").value.trim(),prev=$("#prev").value.trim(),curr=$("#curr").value.trim();
  const noticeText=$("#noticeText").value.trim(),personalNote=$("#personalNote").value.trim();
  if(!name||!prev||!curr){alert("氏名・比較対象値・今回値を入力してください。");return;}
  const out=$("#resultText"); out.value="⏳ Geminiに問い合わせ中…";
  try{
    const res=await fetch(WORKER_URL,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,prev,curr,noticeText,personalNote})
    });
    const txt=await res.text(); console.log("Worker response:",txt);
    let data; try{data=JSON.parse(txt);}catch{throw new Error("JSON parse error: "+txt);}
    if(res.ok && data.text){out.value=data.text.trim();}
    else throw new Error(data.error||"生成失敗");
  }catch(e){console.error(e); out.value="❌ エラー: "+e.message;}
});

// ===== ダミー動画生成 =====
$("#startJob").addEventListener("click",async()=>{
  const name=$("#name").value.trim(); if(!name){alert("氏名を入力してください");return;}
  $("#jobArea").style.display="block";
  const bar=$("#bar"),log=$("#jobLog"); bar.style.width="0%"; log.textContent="";
  const steps=["準備中...","ナレーション作成...","シーン生成...","レンダリング中...","保存完了"];
  for(let i=0;i<steps.length;i++){
    log.textContent+=steps[i]+"\n"; bar.style.width=((i+1)/steps.length*100)+"%";
    await new Promise(r=>setTimeout(r,600));
  }
  const fname=$("#videoName").value||("recoanime_"+name+".mp4");
  $("#videoLink").innerHTML=`<span>出力URL:</span> <a href="/videos/${fname}" target="_blank">${fname}</a>`;
});
$("#reset").addEventListener("click",()=>{
  ["name","prev","curr","noticeText","personalNote","resultText","videoName"].forEach(id=>$("#"+id).value="");
  $("#bar").style.width="0%"; $("#jobLog").textContent=""; $("#videoLink").innerHTML=""; $("#jobArea").style.display="none";
});
</script>
</body>
</html>
