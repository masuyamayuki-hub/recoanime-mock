<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ご家族さま向けお知らせ・生成モック（超軽量・進捗表示付き）</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#fff; --line:#e5e7eb; --muted:#6b7280; --primary:#1e88e5; --primary-weak:#e3f2fd; --accent:#0ea5e9; --mail:#00b894; --radius:14px; }
  *{box-sizing:border-box} body{margin:0;padding:24px;background:var(--bg);font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#111827;line-height:1.6}
  .wrap{max-width:1080px;margin:0 auto}
  h1{margin:0 0 8px;font-size:22px;font-weight:700} .sub{color:var(--muted);margin:0 0 16px;font-size:12px}
  .grid{display:grid;gap:18px} @media (min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .card .hd{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
  .pill{background:var(--primary-weak);color:var(--primary);font-weight:700;padding:3px 10px;border-radius:999px;font-size:12px}
  .inner{padding:16px} label{display:block;font-weight:700;margin:8px 0 6px}
  textarea,input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px;font-size:15px;background:#fff;outline:none}
  textarea{min-height:140px;resize:vertical} textarea:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(14,165,233,.12)}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px} button{appearance:none;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)} .btn-toggle{background:#fff}
  .redbox{border:2px solid #ef4444;border-radius:12px;padding:12px} .meta{font-size:12px;color:var(--muted)}
  .mail{background:#fff;border:1px solid var(--line)} .mail-top{background:var(--mail);color:#fff;padding:10px 14px;font-weight:700;font-size:20px;display:flex;justify-content:space-between}
  .mail-body{padding:16px 18px} .small{font-size:12px} .greet{margin:2px 0 10px}
  .genbox{border:2px solid #ef4444;border-radius:10px;padding:12px;min-height:96px;white-space:pre-wrap;background:#fff}
  .bullet{display:flex;gap:6px;align-items:flex-start}.bullet::before{content:"▼";font-weight:700;margin-top:0}
  .qr-area{display:flex;gap:10px;align-items:center;margin:8px 0 0}
  .qr{width:44px;height:44px;background:conic-gradient(#000 25%,#fff 0 50%,#000 0 75%,#fff 0);mask:radial-gradient(circle at 50% 50%,rgba(0,0,0,.95) 26px, transparent 27px);border:2px solid #111;border-radius:6px}
  .hr{border:none;border-top:1px dashed #9ca3af;margin:14px 0}
  .engine{font-size:12px;color:#fff;opacity:.9}
  .loader{display:inline-flex;align-items:center;gap:6px}.dot{width:6px;height:6px;border-radius:50%;background:#fff;opacity:.8;animation:b 1s infinite alternate}
  .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}@keyframes b{from{transform:translateY(0)}to{transform:translateY(-3px)}}
  .error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:8px;padding:8px 10px;margin-top:8px;font-size:12px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>ご家族さま向けお知らせ・生成モック（超軽量・進捗表示付き）</h1>
  <p class="sub">WebGPUでブラウザ内生成（API不要）。進捗表示・タイムアウト自動フォールバックあり。</p>

  <div class="grid">
    <section class="card">
      <div class="hd"><strong>入力（箇条書き）</strong><span class="pill">左の赤枠</span></div>
      <div class="inner">
        <div class="redbox">
          <label for="bullets">1行=1項目（例：日付＋内容 / 季節の一言 / 注意事項）</label>
          <textarea id="bullets" placeholder="10/12　お買い物イベント（しまむら）&#10;10/20　施設創立30周年&#10;朝晩冷え込み"></textarea>
        </div>
        <div class="btns">
          <button id="sample">サンプル</button>
          <button id="prewarm">エンジン事前読み込み</button>
          <button id="generate" class="btn-primary">生成AIでつくる</button>
          <button id="fallback">簡易生成（擬似）</button>
          <button id="tone" class="btn-toggle" aria-pressed="true" title="丁寧⇄カジュアル切替">文体：丁寧</button>
        </div>
        <p class="meta">※施設名や「●●」は固定。入力内容と文体設定はローカル保存されます。</p>
      </div>
    </section>

    <section class="mail" aria-live="polite">
      <div class="mail-top">
        <span>生成結果（送信メール内容へ反映）</span>
        <span class="engine" id="engineState">Engine: checking…</span>
      </div>
      <div class="mail-body">
        <div class="small">利用者ご家族様</div>
        <div class="greet small">こんにちは。<br>●●事業所の●●です。</div>
        <div class="genbox" id="out">（左の赤枠に箇条書きを入力し、「生成AIでつくる」を押すとここに文章が入ります）</div>
        <div id="err" class="error"></div>
        <p class="small" style="margin-top:10px">利用者様のバーセルインデックス（日常生活活動）の結果をアニメーション形式でお送りいたします。</p>
        <p class="bullet small">動画のご視聴はこちら</p>
        <div class="qr-area"><div class="qr" aria-hidden="true"></div><span class="small">▼QRコードをスマートフォン等で読み取ってください。</span></div>
        <hr class="hr">
        <div class="small">お問い合わせ先<br>テスト事業所<br>東京都テスト市 123-1 建物名<br>TEL:1234567890<br>MAIL:●●@njc.co.jp</div>
      </div>
    </section>
  </div>
</div>

<script src="https://unpkg.com/@mlc-ai/web-llm/dist/index.min.js"></script>
<script>
  const $ = s => document.querySelector(s);
  const bullets = $('#bullets'), out = $('#out'), toneBtn = $('#tone'), engineState = $('#engineState'), err = $('#err');

  if (!('gpu' in navigator)) {
    engineState.textContent = "Engine: WebGPU unsupported (use 簡易生成)";
    out.textContent = 'この端末/ブラウザはWebGPU非対応です。「簡易生成（擬似）」をご利用ください。Chrome/Edge(最新)推奨。';
  }

  let tone = localStorage.getItem('mock.tone') || 'polite';
  function updateToneUI(){ const polite = tone==='polite'; toneBtn.textContent = '文体：'+(polite?'丁寧':'カジュアル'); toneBtn.setAttribute('aria-pressed', polite?'true':'false'); }
  updateToneUI();
  toneBtn.addEventListener('click', ()=>{ tone = (tone==='polite')?'casual':'polite'; localStorage.setItem('mock.tone', tone); updateToneUI(); });

  bullets.value = localStorage.getItem('mock.bullets') || '';
  function save(){ localStorage.setItem('mock.bullets', bullets.value); }

  const kModel = "Phi-3-mini-4k-instruct-q4f32_1-MLC";
  let engine = null;
  let loading = false;

  function onProgress(report){
    if(report && typeof report.progress === 'number'){
      const p = Math.floor(report.progress * 100);
      engineState.textContent = `Engine: downloading… ${p}%`;
    }else if(report && report.text){
      engineState.textContent = `Engine: ${report.text}`;
    }
  }

  async function ensureEngine(){
    if(engine) return engine;
    if(loading) return new Promise((res,rej)=>{
      const iv = setInterval(()=>{ if(engine){ clearInterval(iv); res(engine); } }, 500);
      setTimeout(()=>{ clearInterval(iv); rej(new Error('timeout')); }, 90000);
    });
    try{
      loading = true;
      engineState.textContent = "Engine: loading…";
      engine = await webllm.CreateMLCEngine(kModel, { temperature:0.7, top_p:0.95, initProgressCallback:onProgress });
      engineState.textContent = "Engine: ready ("+kModel+")";
    }catch(e){
      loading = false;
      engineState.textContent = "Engine: failed";
      err.style.display = 'block';
      err.textContent = "モデル初期化に失敗しました。簡易生成をご利用ください。詳細: " + (e && e.message ? e.message : e);
      console.error(e);
      throw e;
    }
    return engine;
  }

  function fitLengthJa(text, min=160, max=220){
    const t = text.replace(/\s+/g,'').replace(/[\u3000]/g,'');
    if(t.length<=max && t.length>=min) return t;
    if(t.length>max){ const cut=t.slice(0,max); const last=Math.max(cut.lastIndexOf('。'),cut.lastIndexOf('！'),cut.lastIndexOf('？')); return (last>80?cut.slice(0,last+1):cut+'。'); }
    return t;
  }

  function pseudoGenerate(text){
    const items = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!items.length) return "（左の赤枠に箇条書きを入力し、「生成AIでつくる」を押してください）";
    const hasSeason = items.find(s=>/(冷え|暑|寒|涼|暖か)/.test(s));
    const greet = hasSeason ? "最近は朝晩の空気もひんやりとしてまいりましたが、皆さまお変わりなくお過ごしでしょうか。" :
                              "いつも当事業所の運営にご理解ご協力を賜り、誠にありがとうございます。";
    const dated = items.filter(s=>/^\d{1,2}\/\d{1,2}/.test(s)).map(s=>s.replace(/^(\d{1,2})\/(\d{1,2}).*?(.*)$/,"$2日に$3を予定しております。")).join("");
    const rest = items.filter(s=>!(/^\d{1,2}\/\d{1,2}/.test(s)||/(冷え|暑|寒|涼|暖か)/.test(s))).join("。");
    return [greet, dated, rest?rest+"。":""].join("");
  }

  async function runLLM(){
    const lines = bullets.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!lines.length){ out.textContent = "（左の赤枠に箇条書きを入力してください）"; return; }
    out.innerHTML = '<span class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span> 生成中…（初回はモデル読込あり）';
    err.style.display='none'; err.textContent='';

    const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error('engine-timeout')), 90000));

    try{
      await Promise.race([ensureEngine(), timeout]);
      const style = (tone==='polite')?'丁寧な敬体（です・ます）':'やわらかいカジュアル体';
      const prompt = [
        "あなたは介護事業所の職員として、ご家族向けのお知らせ文を作成します。",
        "与えられた箇条書きの事実をもとに、200文字前後で日本語の短い段落を1つ作ってください。",
        "文体:", style+"。",
        "条件: 1) 誇張しない 2) 日付は「○日に〜を予定しています」と言い換える 3) 季節の一言があれば冒頭に 4) 結びは簡潔に。",
        "箇条書き:", lines.map(l=>"- "+l).join("\n"),
        "出力は本文のみ。"
      ].join("\n");

      const reply = await engine.chat.completions.create({
        messages:[{role:"user",content:prompt}], stream:false, temperature:0.7, max_tokens:220
      });
      let text = (reply.choices?.[0]?.message?.content || "").trim();
      out.textContent = text ? fitLengthJa(text,160,220) : "（生成できませんでした）";
    }catch(e){
      if(e && e.message === 'engine-timeout'){
        out.textContent = fitLengthJa(pseudoGenerate(bullets.value),160,220);
        err.style.display='block'; err.textContent = "エンジンの準備が90秒以内に完了しなかったため、簡易生成で出力しました。";
      }else{
        out.textContent = "生成に失敗しました。右の「簡易生成（擬似）」をご利用ください。";
        err.style.display='block'; err.textContent = "詳細: "+(e && e.message?e.message:e);
        console.error(e);
      }
    }
    save();
  }

  document.getElementById('prewarm').addEventListener('click', ()=>{ ensureEngine().catch(()=>{}); });
  document.getElementById('generate').addEventListener('click', runLLM);
  document.getElementById('fallback').addEventListener('click', ()=>{ out.textContent = fitLengthJa(pseudoGenerate(bullets.value),160,220); save(); });
  document.getElementById('sample').addEventListener('click', ()=>{ bullets.value=['10/12　お買い物イベント（しまむら）','10/20　施設創立30周年','朝晩冷え込み'].join('\n'); });
  if(!bullets.value) document.getElementById('sample').click();
</script>
</body>
</html>
